{% extends "base.html" %}
{% block content %}

<div class="flex items-end justify-between gap-4 flex-wrap">
  <div>
    <h1 class="text-3xl font-bold">Krep≈°elis</h1>
    <p class="text-sm text-white/60 mt-1">Keisk kiekius ir apmokƒók per PayPal.</p>
  </div>
  <a href="/" class="rounded-2xl px-4 py-2 text-sm border border-white/10 hover:bg-white/5 transition">‚Üê Atgal</a>
</div>

<div class="mt-6 grid gap-4 lg:grid-cols-3">
  <div class="lg:col-span-2 rounded-3xl border border-white/10 bg-white/5 p-6">
    {% if items|length == 0 %}
      <div class="text-center py-10">
        <div class="text-2xl font-semibold">Tu≈°ƒçia ü•≤</div>
        <p class="text-white/60 mt-2">Pridƒók preki≈≥ i≈° produkt≈≥ sƒÖra≈°o.</p>
        <a class="inline-block mt-6 rounded-2xl px-5 py-3 bg-white text-slate-950 font-medium" href="/">Eiti ƒØ produktus</a>
      </div>
    {% else %}
      <div class="grid gap-3">
        {% for it in items %}
        <div class="flex items-center justify-between gap-3 rounded-2xl border border-white/10 bg-slate-950/20 p-4">
          <div class="flex items-center gap-3">
            {% if it.image %}
              <img src="{{ it.image }}" class="h-12 w-12 rounded-xl object-cover border border-white/10" onerror="this.style.display='none'">
            {% endif %}
            <div>
              <div class="font-semibold">{{ it.title }}</div>
              <div class="text-xs text-white/60">‚Ç¨{{ it.price }} ‚Ä¢ qty <span class="font-mono">{{ it.qty }}</span></div>
            </div>
          </div>

          <div class="text-right">
            <div class="font-semibold">‚Ç¨{{ it.line_total }}</div>
            <div class="mt-2 flex gap-2 justify-end">
              <button class="px-3 py-1 rounded-xl border border-white/10 hover:bg-white/5"
                      data-action="dec" data-id="{{ it.id }}" data-qty="{{ it.qty }}">-</button>
              <button class="px-3 py-1 rounded-xl border border-white/10 hover:bg-white/5"
                      data-action="inc" data-id="{{ it.id }}" data-qty="{{ it.qty }}">+</button>
            </div>
          </div>
        </div>
        {% endfor %}
      </div>

      <div class="mt-6 flex gap-2">
        <button class="rounded-2xl px-4 py-2 text-sm border border-white/10 hover:bg-white/5 transition"
                onclick="clearCart()">I≈°valyti krep≈°elƒØ</button>
      </div>
    {% endif %}
  </div>

  <div class="rounded-3xl border border-white/10 bg-white/5 p-6">
    <div class="text-sm text-white/60">Suma</div>
    <div class="mt-1 text-3xl font-bold">‚Ç¨{{ total }}</div>

    <div class="mt-5 rounded-2xl border border-white/10 bg-slate-950/25 p-4">
      <div class="text-sm font-medium">Apmokƒójimas</div>
      <div class="text-xs text-white/60 mt-1">PayPal Checkout</div>
      <div class="mt-4" id="paypal-button-container"></div>

      {% if not paypal_client_id %}
        <div class="mt-3 text-xs text-rose-200">
          PayPal neƒØjungtas: tr≈´ksta <span class="font-mono">PAYPAL_CLIENT_ID</span> / <span class="font-mono">PAYPAL_CLIENT_SECRET</span>.
        </div>
      {% endif %}
    </div>
  </div>
</div>

{% endblock %}

{% block scripts %}
<script>
  document.addEventListener('click', async (e) => {
    const btn = e.target.closest('button[data-action]');
    if (!btn) return;
    const id = btn.dataset.id;
    const qty = parseInt(btn.dataset.qty || "1", 10);
    const action = btn.dataset.action;
    const newQty = action === 'dec' ? (qty - 1) : (qty + 1);

    const r = await fetch('/api/cart/update', {
      method: 'POST',
      headers: {'Content-Type':'application/json'},
      body: JSON.stringify({ id, qty: newQty })
    });
    const j = await r.json();
    if (!j.ok) window.toast?.(j.error || 'Klaida');
    window.location.reload();
  });

  async function clearCart(){
    const r = await fetch('/api/cart/clear', { method:'POST' });
    const j = await r.json();
    if (!j.ok) window.toast?.(j.error || 'Klaida');
    window.location.reload();
  }
</script>

{% if paypal_client_id %}
<script src="https://www.paypal.com/sdk/js?client-id={{ paypal_client_id }}&currency=EUR&intent=capture"></script>
<script>
  paypal.Buttons({
    createOrder: async () => {
      const r = await fetch('/api/paypal/create-order', { method: 'POST' });
      const j = await r.json();
      if (!j.ok) throw new Error(j.error || 'Create order failed');
      return j.id;
    },
    onApprove: async (data) => {
      const r = await fetch('/api/paypal/capture-order', {
        method: 'POST',
        headers: {'Content-Type':'application/json'},
        body: JSON.stringify({ orderID: data.orderID })
      });
      const j = await r.json();
      if (!j.ok) { alert(j.error || 'Capture failed'); return; }
      window.location.href = '/success?order_id=' + encodeURIComponent(data.orderID);
    }
  }).render('#paypal-button-container');
</script>
{% endif %}
{% endblock %}
